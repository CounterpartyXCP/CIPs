    CIP: 14
    Title: Segwit Support
    Authors: Devon Weller
    Status: Draft
    Type: Standards Track
    Created: 2017-09-12
    Discussions-To: https://counterpartytalk.org/t/cip-proposal-segwit-support/3741


# Abstract

This is a proposal to support spending and creating segwit outputs while using Counterparty

* Modify Counterparty Server to generate P2WPKH outputs when sending assets
* Modify Counterparty Server to parse P2WPKH outputs
* Modify Counterwallet to optionally generate a P2WPKH output when sending BTC
* Modify Counterwallet and Counterblock to recognize P2WPKH outputs


# Motivation

Neither Counterparty Server nor Counterwallet are segwit aware.  Assets are sent using standard P2PKH scripts.

By utilizing P2WPKH scripts to send assets, users can spend less on transaction fees sent from Counterparty Server and Counterwallet.  Adding segwit compatibility to Counterparty Server enables potential future enhancements.


# Rationale

### Segwit Implementation

Segwit can be enabled in two ways.

1. P2WPKH output scripts
2. Embedding a P2WPKH script inside a P2SH script, or P2SH(P2WPKH)

Using P2WPKH output scripts would remain compatible with the standard 1xxxx address types that Counterwallet currently uses.  By using P2WPKH scripts, we only require a relatively minor upgrade to Counterwallet.

Using P2SH(P2WPKH) would require a significantly more complex update to Countewallet.

Since a large percentage of addresses that hold Counterparty assets are used exclusively by Counterparty Server and Counterwallet we will use P2WPK output scripts.

### Sending BTC

Care must be taken when sending BTC using Counterparty.  Since a recipient of BTC may not be using a segwit compatible wallet, we must give the user the choice of using a segwit (P2WPKH) output or a traditional (P2PKH) output.

### Bitcoin Core v0.13.2

We will continue to use the addrindex-0.13.2 version of bitcoind at this time.  Segwit address are no different than normal addresses, so the addrindex patch will continue to work as expected.


# Specification

### Transactions Generated by Counterparty Server

The `create_send` API method will include a new parameter called `segwit`.  This parameter is True by default and will generate P2WPKH outputs when sending assets.  If this is set to False, then the send will generate P2PKH outputs.  Note that sends to P2SH addresses are unaffected by this parameter.

All other Counterparty API methods will use P2WPKH output scripts when generating transactions.

### Counterwallet Changes

When sending BTC, Counterwallet will allow the user to choose whether the output is segwit enabled.  This will be No by default.

All other actions in Counterwallet will generate segwit outputs by default.

### Transaction Parsing by Counterparty Server

Counterparty server will parse P2WPKH output scripts in addition to P2PKH outputs.



# Backwards Compatibility

Segwit support will be a consensus change that will activate at a specific block to be determined after implementation.  All parsing servers will need to upgrade before this block to maintain consensus.


# Implementation

Pending


# Milestones

### Fundraising goal = 400 XCP

#### Milestone #1 (70% - 280 XCP) 
Counterparty Server and Counterwallet code merged into the master branch

#### Milestone #2 (30% - 120 XCP) 
Code Released and supported on Mainnet for 1 month


#### Bounty Address (escrow by J-Dog)
TBD


# Copyright

This document is placed in the public domain.



